# =============================================================
# SkyGuard Load Balancer Configuration
# Host: Lb01 (54.174.137.211)
# File: deploy/nginx.conf
# =============================================================

# 1. Define Rate Limiting Zone (Bonus Requirement)
# Allocates 10MB memory for IP states, limits to 10 requests/second per IP
limit_req_zone $binary_remote_addr zone=skyguard_limit:10m rate=10r/s ;

# 2. Define the backend server group (Web01 & Web02)
upstream skyguard_backend {
# Round-Robin Load Balancing
server 44.204.88.221:80     ;  # Web01
server 52.91.16.179:80      ;   # Web02
}

server {
listen 80                  ;
server_name 54.174.137.211 ; # Public IP of Lb01

# Safety: Limit upload size
client_max_body_size 1M ;

# 3. Main Application Route
location /skyguard/ {
# Apply Rate Limiting (burst=20 allows short spikes, nodelay processes instantly)
limit_req zone=skyguard_limit burst=20 nodelay ;

# Proxy traffic to the upstream group
proxy_pass http://skyguard_backend/skyguard/ ;

# Forward critical client info headers
proxy_set_header Host $host                                 ;
proxy_set_header X-Real-IP $remote_addr                     ;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for ;

# Security: Hide backend details
proxy_redirect off ;

# 4. Timeout Handling (Requirement: API timeout handling)
proxy_connect_timeout 5s ;  # Fast fail if backend is totally down
proxy_send_timeout 30s   ;    # Max time to send request
proxy_read_timeout 30s   ;    # Max time to wait for response
}

# Root Redirect: Send users hitting the IP directly to the app
location / {
return 302 /skyguard/index.html ;
}

# 5. User-Friendly Error Messages
error_page 500 502 503 504 /50x.html ;
location = /50x.html {
root /usr/share/nginx/html           ;
internal                             ;
}
}
